# Оптимизация хвостовых вызовов в ECMAScript 6

Спецификация ECMAScript 6 предлагает оптимизацию хвостовых вызовов, теперь вы можете совершать вызовы некоторых функций без увеличения стека вызовов. В данной статье объясняется, как это работает и какая от этого выгода.

## 1. Что такое оптимизация хвостовых вызовов?

 Чтобы понять, что такое оптимизация хвостовых вызовов (TCO - tail call optimization), мы рассмотрим фрагмент кода, представленный ниже. Сначала я объясню как этот код выполняется без TCO, а затем с TCO.

```js
function id(x) {
    return x; // (A)
}
function f(a) {
    let b = a + 1;
    return id(b); // (B)
}
console.log(f(2)); // (C)
```

## 1. Нормальное выполнение

 Предположим, что есть JavaScript движок, который управляет вызовами функций, сохраняя локальные переменные и адреса возврата в стеке. Как такой движок будет выполнять код?

**Шаг 1.** Первоначально в стек попадают только глобальные переменные id и f.

![pic1](http://2ality.com/2015/06/tail-call-optimization/stack_frames_1.jpg)

Блок записей стека кодирует состояние (локальные переменные, включая параметры) текущей области и называется стековым кадром.

**Шаг 2.** В строке С вызывается функция f(). Сначала в стеке сохраняется место возврата. Затем сохраняются параметр функции f() и ее локальная переменная, и после этого выполнение переходит к телу функции. Стек теперь выглядит следующим образом:

![pic2](http://2ality.com/2015/06/tail-call-optimization/stack_frames_2.jpg)

Теперь в стеке 2 кадра: один для глобальной области (снизу), и один для функции f() (сверху). Стековый кадр функции f() включает в себя адрес возврата, строку С.

**Шаг 3.** Функиця id() вызвается в строке B. Снова создается стековый кадр, содержащий адрес возврата и параметр функции id.

![pic3](http://2ality.com/2015/06/tail-call-optimization/stack_frames_3.jpg)

**Шаг 4.** В строке A возвращается результат x. Стековый кадр функции id удаляется, и выполнение переходит к адресу возврата, строке B. (Существует несколько способов возврата значения. Есть два обычных решения - оставить результат в стеке или передать его в регистр. В данной статье я игнорирую эту часть исполнения.)

Сейчас стек выглядит так:

![pic4](http://2ality.com/2015/06/tail-call-optimization/stack_frames_2.jpg)

**Шаг 5.** В строке B значение, возвращаемое функцией id, передается в вызывающую функцию f. Снова удаляется верхний стековый кадр и выполнение переходит к адресу возврата, строка С.

![pic5](http://2ality.com/2015/06/tail-call-optimization/stack_frames_1.jpg)

**Шаг 6.** Строка C получает значение 3 и выводит его в консоль.